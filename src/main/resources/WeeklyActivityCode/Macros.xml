<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc>
  <web>WeeklyActivityCode</web>
  <name>Macros</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>WebHome</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1408609534000</creationDate>
  <date>1408630754000</date>
  <contentUpdateDate>1408630754000</contentUpdateDate>
  <version>1.1</version>
  <title>Macros</title>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.0</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity output="false"}}

#set ($activityClassMap = {
  'done' : 'WeeklyActivityCode.DoneActivityClass',
  'planned' : 'WeeklyActivityCode.PlannedActivityClass'
})

##
## Display start/end date
## -------------------------
#macro(displayStartEndDate $propName)
  #if($context.action == 'view' &amp;&amp; "$!doc.get('startDate')" != '' &amp;&amp; "$!doc.get('endDate')" != '')
    #set($startDateObj = $doc.getObject('WeeklyActivityCode.ActivityClass'))
    #set($startDate = $startDateObj.getProperty('startDate').value)
    #set($endDate = $startDateObj.getProperty('endDate').value)
    #set($startDateFormat = 'EEEE dd MMMM')
    #if($startDate.year != $endDate.year)
      #set($startDateFormat = 'EEEE dd MMMM yyyy')
    #end
    //$xwiki.formatDate($startDate, $startDateFormat) - $xwiki.formatDate($endDate, 'EEEE dd MMMM yyyy')//
  #else
    #displayStartEndDateProp('startDate')
    #displayStartEndDateProp('endDate')
  #end
#end

##
## Display start/end date property
## Used in edit/inline mode
## -------------------------
#macro(displayStartEndDateProp $propName)
  ; $msg.get("weeklyActivity.sheet.${propName}")
  : #if("$!request.get(${propName})" != '')

  {{html}}
  &lt;input type="text" name="WeeklyActivityCode.ActivityClass_0_${propName}" value="$!request.get(${propName})" id="WeeklyActivityCode.ActivityClass_0_${propName}" size="20"&gt;
  {{/html}}

  #else $doc.display("$!propName") #end

#end

##
## Display activity section
## -------------------------
#macro(displayActivity $type $action)
  (% class="activity-sheet-title" %)(((
    $msg.get("weeklyActivity.sheet.${type}Activity.title")
  )))
  #if($action == 'edit')
    #displayActivityAddFormEdit($type)
    #displayActivityEdit($type)
    #if($doc.getObjectNumbers(${activityClassMap.get($type)}) &gt; 2)
      #displayActivityAddFormEdit($type)
    #end
  #else
    #displayActivityLivetable($type)
  #end
#end

##
## Display activity livetable
## -------------------------
#macro(displayActivityLivetable $type)
  #if($activityClassMap.keySet().contains("$!type"))
    #set($collist = $util.arrayList)
    #set($discard = $collist.addAll(['user']))
    #set($discard = $collist.add('project'))
    #set($discard = $collist.add('details'))
    #set($startDateTime = $doc.getObject('WeeklyActivityCode.ActivityClass').getProperty('startDate').value.getTime())
    #set($colprops = {
                   'user' : { 'type' : 'text', 'link' : 'field', 'sortable' : 'false', 'html' : 'true' },
                   'details' : { 'type' : 'text', 'sortable' : 'false' }
                 })
    #if($xwiki.exists('ProjectsCode.ProjectsCodeClass')) ## Check if Project Management App is installed
      #set($discard = $colprops.put('project', { 'type' : 'text', 'sortable' : 'false', 'link' : 'field' }))
    #else ## If not, we have to disable the link
      #set($discard = $colprops.put('project', { 'type' : 'text', 'sortable' : 'false' }))
    #end
    #if($type == 'planned')
      #set($discard = $collist.add('days'))
      #set($discard = $collist.add('priority'))
      #set($discard = $colprops.put('days', { 'type' : 'list', 'sortable' : 'false', 'html' : 'true' }))
      #set($discard = $colprops.put('priority', { 'type' : 'list' }))
    #elseif($type == 'done')
      #set($discard = $collist.add('hours'))
      #set($discard = $colprops.put('hours', { 'type' : 'text', 'sortable' : 'false', 'filterable' : 'false' }))
    #end
    #set($options = {
                  'className' : "${activityClassMap.get($type)}",
                  'resultPage' : 'WeeklyActivityCode.ActivityLivetableResultsSheet',
                  'translationPrefix' : 'weeklyActivity.livetable.',
                  'extraParams' : "fullName=$doc.fullName",
                  'rowCount': 10 })
    #livetable("${type}activity" $collist $colprops $options)
  #end
#end

##
## Display activity add form in EDIT mode
## -------------------------
#macro(displayActivityAddFormEdit $type)
  #if($hasEdit)
    {{html}}
      #set($objClassName = $!activityClassMap.get("$!type"))
      #set($objAddRedirectURL = $doc.getURL('edit', "tab=$!{type}&amp;editor=inline"))
      #set($objAddURL = $doc.getURL('edit', "xpage=editobject&amp;xaction=addObject&amp;className=${objClassName}&amp;xredirect=${objAddRedirectURL}"))
      &lt;br /&gt;
        &lt;div class="buttonwrapper"&gt;
          &lt;a href="$objAddURL" class="button"&gt;$msg.get("weeklyActivity.sheet.add_type.$type")&lt;/a&gt;
        &lt;/div&gt;
        &lt;input class="hidden" name="addClassName" value="$objClassName" /&gt;
      &lt;br /&gt;&lt;br /&gt;
    {{/html}}
  #end
#end

##
## Display planned activity section in EDIT mode
## -------------------------
#macro(displayActivityEdit $type)
  #if($activityClassMap.keySet().contains("$!type"))
    #set ($pClass = $xwiki.getClass($activityClassMap.get($type)))
    #set ($pProps = $class.getProperties())
    #foreach ($prop in $props)
      #if ($velocityCount==1)
        #set ($firstField = $prop.name)
        #break
      #end
    #end ## foreach prop
    #foreach($pObj in $doc.getObjects($pClass.name))
      #set($activityDisplayClassName = '')
      #if($type != 'done' || $pObj.getProperty('user').value == $context.user || "$!pObj.getProperty('user').value" == '')
        {{html clean="false"}}
          &lt;div class="activity$!{activityDisplayClassName}"&gt;
            #displayObject($doc $type $pObj $pClass $pProps $firstField)
        {{/html}}
      #end
    #end
  #end
#end

##
## Display an object
## -------------------------
#macro(displayObject $activityDoc $activityType $obj $class $props $firstfield)
  ## -----------------------
  ## Start Activity code
  ## -----------------------
  #if($context.action == 'view' &amp;&amp; $doc.getObject('WeeklyActivityCode.ActivityClass'))
    &lt;div class="activity-modal-box-title"&gt;$msg.get("weeklyActivity.sheet.add-${activityType}-activity")&lt;/div&gt;
  #end
  ## -----------------------
  ## End Activity code
  ## -----------------------
  &lt;div id="xobject_${escapetool.xml($class.name)}_${obj.number}_content" class="xobject-content"&gt;&lt;div&gt;
    #set($removeRedirectURL = $activityDoc.getURL('edit', "tab=${activityType}"))
#set($objRemoveURL = $activityDoc.getURL('objectremove', "classname=${obj.getxWikiClass().getName()}&amp;amp;classid=${obj.number}&amp;amp;form_token=$!{services.csrf.getToken()}"))
    #if($doc.getObject('WeeklyActivityCode.ActivityClass'))
      #set($objRemoveURL = $objRemoveURL + "&amp;amp;xredirect=$removeRedirectURL")
    #end
    &lt;a title="Remove this activity" class="xobject-action delete" href="${objRemoveURL}"&gt;$msg.get("weeklyActivity.sheet.delete.object")&lt;/a&gt;
    &lt;input type="hidden" name="className" value="${obj.getxWikiClass().getName()}" /&gt;
    &lt;input type="hidden" name="classId" value="${obj.number}" /&gt;

    &lt;dl&gt;
    #if ($hasCustomField)
      #set ($properties = $util.arrayList)
      #foreach ($propName in $customField.split(','))
        #set ($discard = $properties.add($class.get($propName)))
      #end
    #else
      #set ($properties = $class.properties)
    #end
    ## -----------------------
    ## Start Activity code
    ## -----------------------
    #foreach ($prop in $properties)
      #set($startDateTime = $!activityDoc.getObject('WeeklyActivityCode.ActivityClass').getProperty('startDate').value.getTime())
      #set($discard = $collist.add('days'))
      #if($activityClassMap.keySet().contains("$!type") &amp;&amp; 
          ("$!prop.name" == 'user' || 
           "$!prop.name" == 'days' || 
           "$!prop.name" == 'hours_1')
      )
        &lt;div #if("$!prop.name" == 'user') class="activity-inner" #elseif("$!prop.name" == 'hours_1') class="day-hours" #end&gt;
      #end
      #if($activityClassMap.keySet().contains("$!type") &amp;&amp; "$!prop.name" == 'hours_1')
        &lt;div class="activity-hours-label"&gt;$msg.get('weeklyActivity.sheet.hours.label')&lt;/div&gt;
      #end
      #if($activityClassMap.keySet().contains("$!type") &amp;&amp; $!prop.name.indexOf('hours') == 0)
        &lt;div class="activity-day-hours"&gt;
      #end      
      &lt;dt class="label#if($prop.isDisabled()) disabled#end"&gt;&lt;label for="${escapetool.xml($class.name)}_${obj.number}_${escapetool.xml($prop.name)}"&gt;$msg.get("weeklyActivity.sheet.$prop.Name")&lt;/label&gt;&lt;/dt&gt;
      &lt;dd class="activityobj-${prop.name} #if ($prop.isDisabled()) disabled #end satisfaction_div"&gt;
        ##
        ## Satisfaction
        ##
        #if($activityClassMap.keySet().contains("$!type") &amp;&amp; "$!prop.name" == 'satisfaction')
          #set($satisfactionCustomDisplay = {'1' : '2.png', '2' : '5.png', '3' : '6.png', '4' : '8.png', '5' : '10.png'})
          #set($satisfactionObjValues = $obj.getProperty('satisfaction').value) 
          #foreach ($pCustomValue in $satisfactionCustomDisplay.keySet())
            &lt;label for="xwiki-form-satisfaction-${obj.number}-${pCustomValue}"&gt;&lt;input type="radio" value="${pCustomValue}" name="${escapetool.xml($class.name)}_${obj.number}_satisfaction" id="xwiki-form-satisfaction-${obj.number}-${pCustomValue}" class="satisfaction_input" #if($satisfactionObjValues.contains($pCustomValue)) checked="checked" #end&gt;&lt;img src="$xwiki.getDocument('WeeklyActivity.WebHome').getAttachmentURL("$satisfactionCustomDisplay.get($pCustomValue)")"  height="115px" width="100px"/&gt;&lt;/label&gt;
          #end
        #elseif($activityClassMap.keySet().contains("$!type") &amp;&amp; "$!prop.name" == 'salesOrder')
          #if($xwiki.exists('ProjectsCode.SalesOrderClass'))
            #set($pSuggestName = "${escapetool.xml($class.name)}_${obj.number}_${prop.name}_suggest")
            #set($pSuggestURL = $xwiki.getURL('WeeklyActivityCode.SuggestAjaxSO', 'view', "xpage=plain&amp;outputSyntax=plain"))
            #set($pOnFocus = "new ajaxSuggest(this, {script:&amp;quot;${pSuggestURL}&amp;amp;&amp;quot;,varname:&amp;quot;input&amp;quot;})")
            #set($pValue = $!obj.getProperty('salesOrder').value)
            $activityDoc.displayHidden($prop, "${escapetool.xml($class.name)}_${obj.number}_", $obj)&lt;input type="text" value="$!pValue" name="${pSuggestName}" id="${pSuggestName}" class="suggested" onfocus="${pOnFocus}" /&gt;
          #else
            $activityDoc.displayHidden($prop, "${escapetool.xml($class.name)}_${obj.number}_", $obj)
            $services.localization.render('weeklyActivity.sheet.installProject')
          #end
        #elseif($activityClassMap.keySet().contains("$!type") &amp;&amp; "$!prop.name" == 'userType')
          #if($xwiki.exists('ProjectsCode.SalesOrderClass'))
            $activityDoc.displayEdit($prop, "${escapetool.xml($class.name)}_${obj.number}_", $obj)
          #else
            $activityDoc.displayHidden($prop, "${escapetool.xml($class.name)}_${obj.number}_", $obj)
            $services.localization.render('weeklyActivity.sheet.installProject')
          #end
        #else
          {{/html}}
          $activityDoc.display($prop.name, "edit", $obj)
          {{html}}
        #end
      &lt;/dd&gt;
      #if($activityClassMap.keySet().contains("$!type") &amp;&amp; 
         ("$!prop.name" == 'project' || 
          "$!prop.name" == 'hours' || 
          "$!prop.name" == 'priority' ||
          "$!prop.name" == 'hours_7')
         )
        &lt;/div&gt;
      #end
      #if($activityClassMap.keySet().contains("$!type") &amp;&amp; $!prop.name.indexOf('hours') == 0)
        &lt;/div&gt;
      #end
      #if($activityClassMap.keySet().contains("$!type") &amp;&amp; "$!prop.name" == 'hours_7')
        &lt;div class="clearfloats"&gt;&lt;/div&gt;
      #end
    #end
    ## -----------------------
    ## End Activity code
    ## -----------------------
    &lt;/dl&gt;
  &lt;/div&gt;&lt;/div&gt;## xobject-content
  &lt;/div&gt;## xobject
#end

#macro(displayCopyDoneActivityFromPlanned)
  #if($hasAdmin)
    (% class="buttonwrapper" %)(((
      {{html}}&lt;a class="button float_right" onclick="return confirm ('$msg.get('weeklyActivity.sheet.confirm.button')')" href="$doc.getURL('view', 'updateDone=1')"&gt;$msg.get('weeklyActivity.sheet.updatedone.button')&lt;/a&gt;{{/html}}
    )))
  #end
#end

#macro(displayEditActivity $type)
  (% class="buttonwrapper" %)(((
    #if($type == "done")
      {{html}}&lt;div class="clear_both"&gt;&lt;/div&gt;&lt;a class="button float_right" href="$doc.getURL("edit", "tab=$type")"&gt;$msg.get('weeklyActivity.sheet.editdone.button')&lt;/a&gt;{{/html}}
    #elseif($type == "planned")
      {{html}}&lt;div class="clear_both"&gt;&lt;/div&gt;&lt;a class="button float_right" href="$doc.getURL("edit", "tab=$type")"&gt;$msg.get('weeklyActivity.sheet.editplanned.button')&lt;/a&gt;{{/html}}
    #end
  )))
#end

#macro(updateDoneActivityFromPlanned)
  #if($hasAdmin &amp;&amp; "$!request.updateDone" == '1')
    $doc.removeObjects('WeeklyActivityCode.DoneActivityClass')
    #foreach($obj in $doc.getObjects('WeeklyActivityCode.PlannedActivityClass'))
      #set($dObj = $doc.newObject('WeeklyActivityCode.DoneActivityClass'))
      #set($discard = $dObj.set('user', $obj.getProperty('user').value))
      #set($discard = $dObj.set('project', $obj.getProperty('project').value))
      #set($discard = $dObj.set('salesOrder', $obj.getProperty('salesOrder').value))
      #set($discard = $dObj.set('userType', $obj.getProperty('userType').value))
    #end
    $doc.save()
    $response.sendRedirect($doc.getURL('view'))
  #end
#end

{{/velocity}}</content>
</xwikidoc>
